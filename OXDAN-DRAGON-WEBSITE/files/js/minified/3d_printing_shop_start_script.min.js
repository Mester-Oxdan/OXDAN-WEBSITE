let products=[];async function loadProducts(e="all",t=""){const n=await fetch(`/api/get_products.php?category=${encodeURIComponent(e)}&search=${encodeURIComponent(t)}`);products=await n.json(),displayAllProducts(e)}document.addEventListener("DOMContentLoaded",(()=>{loadProducts("all")}));let searchHistory=[];function getUserToken(){let e=localStorage.getItem("user_token");return e||null}function getBasePath(){const e=window.location.pathname;return e.includes("/catalogs_html/")||e.includes("/toys/")||e.includes("/key chains/")||e.includes("/flower pots/")?"/api/":"/api/"}const basePath=getBasePath();async function generateSecureToken(){try{const e=await fetch(`${basePath}favorites_manager.php?action=generate_token`,{method:"POST",credentials:"include"}),t=await e.json();return t.success?(localStorage.setItem("user_token",t.user_token),t.user_token):null}catch(e){return null}}async function toggleFavoriteDB(e){try{let t=getUserToken();const n=await fetch(`${basePath}favorites_manager.php?action=toggle`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({product_id:e,user_token:t})}),o=await n.json();return o.user_token&&localStorage.setItem("user_token",o.user_token),o.success?o.favorite:null}catch(e){return null}}async function getFavoriteStateDB(e){try{const t=getUserToken();if(!t)return!1;const n=await fetch(`${basePath}favorites_manager.php?action=get&product_id=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_token:t})}),o=await n.json();return!!o.success&&o.favorite}catch(e){return!1}}function displayAllProducts(e){const t=document.getElementById("searchResults");if(!t)return;t.innerHTML="";("all"===e||""===e?products:products.filter((t=>t.category.includes(e)))).forEach((e=>{const n=createItemContainer(e);t.appendChild(n)}))}function addToSearchHistory(e){searchHistory=searchHistory.filter((t=>t!==e)),searchHistory.unshift(e),saveSearchHistory()}function createItemContainer(e){const t=document.createElement("div");t.classList.add("search-item"),t.style.backgroundImage=`url(${e.image})`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",t.style.cursor="pointer",t.style.zIndex="1";const n=document.createElement("a");n.innerHTML=e.name,t.appendChild(n);const o=document.createElement("b");o.innerHTML=e.price,t.appendChild(o);const s=document.createElement("p");s.innerHTML=e.description?e.description:"",t.appendChild(s);const a=document.createElement("button");return a.classList.add("like-button"),a.innerHTML='\n  <div class="like-wrapper">\n    <div class="ripple"></div>\n    <svg class="heart" width="24" height="24" viewBox="0 0 24 24">\n      <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path>\n    </svg>\n    <div class="particles" style="--total-particles: 6">\n      <div class="particle" style="--i: 1; --color: #7642F0"></div>\n      <div class="particle" style="--i: 2; --color: #AFD27F"></div>\n      <div class="particle" style="--i: 3; --color: #DE8F4F"></div>\n      <div class="particle" style="--i: 4; --color: #D0516B"></div>\n      <div class="particle" style="--i: 5; --color: #5686F2"></div>\n      <div class="particle" style="--i: 6; --color: #D53EF3"></div>\n    </div>\n  </div>',a.style.right="10px",getFavoriteStateDB(e.number).then((e=>{e?a.classList.add("active"):a.classList.remove("active")})),a.addEventListener("click",(async t=>{t.stopPropagation();const n=await toggleFavoriteDB(e.number);if(null!==n){n?a.classList.add("active"):a.classList.remove("active");document.getElementById("toggleFavorite").checked&&displayFavoriteProducts()}})),t.appendChild(a),t.addEventListener("click",(()=>{addToSearchHistory(e.name),window.location.href=getProductLink(e)})),t}function getProductLink(e){return`../${e.url}`}displayAllProducts("all");const categorySelect=document.getElementById("categorySelect");function search(){const e=document.getElementById("categorySelect").value,t=document.getElementById("searchInput").value.trim().toLowerCase(),n=document.getElementById("searchResults"),o=document.getElementById("toggleFavorite");n.innerHTML="";let s=products.filter((n=>("all"===e||""===e||!!n.category.includes(e))&&n.name.toLowerCase().startsWith(t)));o.checked&&(s=s.filter((e=>{const t=e.heartButton;return t&&t.classList.contains("active")}))),0===s.length?n.textContent="No items found. Please try another search term or category.":s.forEach((e=>{const t=createItemContainer(e);n.appendChild(t)}))}function saveSearchHistory(){localStorage.setItem("searchHistory",JSON.stringify(searchHistory))}function loadSearchHistory(){const e=localStorage.getItem("searchHistory");e?(searchHistory=JSON.parse(e),search()):displayAllProducts("all")}categorySelect&&categorySelect.addEventListener("change",(function(){search()})),document.addEventListener("DOMContentLoaded",(function(){document.getElementById("test").click()})),loadSearchHistory(),document.getElementById("searchInput").addEventListener("keypress",(function(e){"Enter"===e.key&&search()}));let suggestionsEnabled=!1;function showSuggestions(){if(0!=suggestionsEnabled){const e=document.getElementById("searchInput").value.toLowerCase(),t=document.getElementById("suggestions");t.innerHTML="";const n=products.filter((t=>t.name.toLowerCase().includes(e)));""!==e&&n.forEach((e=>{const n=document.createElement("div");n.textContent=e.name,n.classList.add("suggestion"),n.onclick=()=>{document.getElementById("searchInput").value=e.name,addToSearchHistory(e.name),search(),t.innerHTML=""},t.appendChild(n)})),t.style.display="block"}}function toggleSuggestions(){const e=document.getElementById("toggleSuggestions");document.getElementById("suggestions");suggestionsEnabled=!!e.checked}function toggleFavoriteItems(){document.getElementById("toggleFavorite").checked?displayFavoriteProducts():search()}async function displayFavoriteProducts(){const e=document.getElementById("searchResults");e.innerHTML="";const t=getUserToken();if(t)try{const n=await fetch(`${basePath}favorites_manager.php?action=list`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({user_token:t})}),o=await n.json();if(o.success){const t=o.favorites;0===t.length?e.textContent="No favorite items found.":t.forEach((t=>{const n=createItemContainer(t);e.appendChild(n)}))}else e.textContent="Error loading favorites."}catch(t){e.textContent="Error loading favorites."}else e.textContent="No favorite items found."}const toggleSwitch=document.getElementById("toggleFavorite");toggleSwitch.addEventListener("change",toggleFavoriteItems),toggleSwitch.checked?displayFavoriteProducts():search();
